<form #instanceVariableForm="ngForm"
      *ngIf="instanceVariable; else loadingInstanceVariable;">

  <div class="row">
    <div class="col-xs-12">
      <h1 *ngIf="instanceVariable.id; else newInstanceVariable;">
        {{ instanceVariable.prefLabel | lang }}
      </h1>
      <ng-template #newInstanceVariable>
        <h1>{{ 'newInstanceVariable' | translate }}</h1>
      </ng-template>
    </div>
  </div>

  <div class="row bg-highlight">
    <div class="col-md-4">
      <div class="form-group">
        <label for="variable">{{ 'variable' | translate }}</label>
        <br>
        <p-autoComplete
          [(ngModel)]="instanceVariable.variable"
          [ngModelOptions]="{ standalone: true }"
          [suggestions]="variableSearchResults"
          (completeMethod)="searchVariable($event)"
          dataKey="id"
          minLength="2"
          inputId="variable"
          field="{{'prefLabel.'+language}}"
          emptyMessage="{{'noSearchResults' | translate}}"
          placeholder="{{'searchForVariables' | translate}}">

          <ng-template let-variable pTemplate="item">
            <ng-container>
                {{ variable.prefLabel | lang }}
                <small style="opacity:.7">
                  <ng-container *ngIf="variable.description | lang">
                        <br>
                        {{ variable.description | lang | truncate:70 }}
                  </ng-container>
                </small>
            </ng-container>
          </ng-template>

        </p-autoComplete>

        <span style="padding-left: 1em; padding-right:1em">|</span>

        <button (click)="editVariableModal.show()"
          class="btn btn-sm btn-default">
          <span class="glyphicon glyphicon-plus"></span>
          {{ 'addVariable' | translate }}
        </button>
      </div>
    </div>
    <div class="col-md-8">
      <p class="preserve-line-breaks">{{ 'variableHelpText' | translate }}</p>
    </div>
  </div>

  <edit-variable-modal
      (variableSaved)="updateVariable($event)"
      #editVariableModal>
  </edit-variable-modal>

  <div [ngClass]="{ 'bg-danger': formErrors.prefLabel && formErrors.prefLabel.length }"
       class="row">
    <div class="col-xs-12">
      <div [ngClass]="{ 'has-error': formErrors.prefLabel && formErrors.prefLabel.length }"
           class="form-group">
        <label for="prefLabel">
          {{ 'prefLabel' | translate }}
          <thl-requiredFieldIndicator></thl-requiredFieldIndicator>
        </label>
        <input [(ngModel)]="instanceVariable.prefLabel[language]"
          id="prefLabel"
          name="prefLabel"
          type="text"
          class="form-control"
          required>
        <p *ngFor="let errorKey of formErrors.prefLabel"
             class="text-danger">
          <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
          {{ errorKey | translate }}
        </p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="technicalName" translate="technicalName"></label>
        <input [(ngModel)]="instanceVariable.technicalName"
          id="technicalName"
          name="technicalName"
          type="text"
          class="form-control">
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="description">{{ 'description' | translate }}</label>
        <textarea [(ngModel)]="instanceVariable.description[language]"
          thlAutogrow
          id="description"
          name="description"
          class="form-control"
          rows="3">
        </textarea>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="partOfGroup">{{ 'partOfGroup' | translate }}</label>
        <input [(ngModel)]="instanceVariable.partOfGroup[language]"
               id="partOfGroup"
               name="partOfGroup"
               type="text"
               class="form-control">
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="conceptsFromScheme">{{ 'conceptsFromScheme' | translate }}</label>
        <br>
        <p-autoComplete
          [(ngModel)]="instanceVariable.conceptsFromScheme"
          [ngModelOptions]="{ standalone: true }"
          [suggestions]="conceptSearchResults"
          (completeMethod)="searchConcept($event)"
          [multiple]="true"
          dataKey="id"
          emptyMessage="{{ 'noMatchingConcepts' | translate }}"
          placeholder="{{ 'conceptsFromSchemePlaceholder' | translate }}"
          minLength="2"
          inputId="conceptsFromScheme">

         <ng-template let-concept pTemplate="item">
            <span>
              {{ concept.prefLabel | lang }}
            </span>
            <small style="opacity:.7">
              <span *ngFor="let lang of getConceptLanguages(concept)">
                {{ lang }}:
                {{ concept.prefLabel[lang] }}
              </span>
              ({{ concept.conceptScheme.prefLabel | lang }})
            </small>
          </ng-template>

          <ng-template let-concept pTemplate="selectedItem">
            <span style="margin-right:1.2em;">
              <span>
                {{ concept.prefLabel | lang }}
              </span>
              <span style="opacity:.4">
                ({{ concept.conceptScheme.prefLabel | lang }})
              </span>
            </span>
          </ng-template>
        </p-autoComplete>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="freeConcepts">{{ 'freeConcepts' | translate }}</label>
        <p-chips [(ngModel)]="freeConcepts"
           [ngModelOptions]="{ standalone: true }"
           inputId="freeConcepts">
        </p-chips>
        <p class="help-block">{{ 'freeConceptsHelpText' | translate }}</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-6 col-md-4">
      <div class="form-group">
        <label for="referencePeriodStart">{{ 'referencePeriodStart' | translate }}</label>
        <iso-datepicker
          [(dateAsString)]="instanceVariable.referencePeriodStart"
          id="referencePeriodStart"
          name="referencePeriodStart">
        </iso-datepicker>
      </div>
    </div>
    <div class="col-sm-6 col-md-4">
      <div class="form-group">
        <label for="referencePeriodEnd">{{ 'referencePeriodEnd' | translate }}</label>
        <iso-datepicker
          [(dateAsString)]="instanceVariable.referencePeriodEnd"
          id="referencePeriodEnd"
          name="referencePeriodEnd">
        </iso-datepicker>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-6 col-md-4">
      <div class="form-group">
        <label for="value-domain-type">{{ 'valueDomainType.label' | translate }}</label>
        <div id="value-domain-type" class="radio">
          <label>
            <input [(ngModel)]="instanceVariable.valueDomainType" name="value-domain-type" type="radio" value="described">
            {{ 'valueDomainType.described' | translate }}
          </label>
        </div>
        <div class="radio">
          <label>
            <input [(ngModel)]="instanceVariable.valueDomainType" name="value-domain-type" type="radio" value="enumerated">
            {{ 'valueDomainType.enumerated' | translate }}
          </label>
        </div>
      </div>
    </div>
  </div>

  <ng-container *ngIf="instanceVariable.valueDomainType == 'described'">
    <ng-container *ngIf="allQuantityItems.length">
      <div class="row">
        <div class="col-xs-12">
          <div class="form-group">
            <label>{{ 'quantity' | translate }}</label>
            <br>
            <p-dropdown [(ngModel)]="instanceVariable.quantity"
                        [ngModelOptions]="{ standalone: true }"
                        [options]="allQuantityItems"
                        filter="true">
            </p-dropdown>
            <span style="padding-left:1em;padding-right:1em">|</span>
            <button
              (click)="showAddQuantityModal()"
              class="btn btn-default btn-sm">
              <span class="glyphicon glyphicon-plus"></span>
              {{ 'addQuantity' | translate }}
            </button>
          </div>
        </div>
      </div>
      <quantity-edit-modal *ngIf="newQuantity"
                       [quantity]="newQuantity"
                       (onSave)="saveQuantity($event)"
                       (onCancel)="closeAddQuantityModal()">
      </quantity-edit-modal>
    </ng-container>
    <ng-container *ngIf="allUnitItems.length">
      <div class="row">
        <div class="col-xs-12">
          <div class="form-group">
            <label>{{ 'unit' | translate }}</label>
            <br>
            <p-dropdown [(ngModel)]="instanceVariable.unit"
                        [ngModelOptions]="{ standalone: true }"
                        [options]="allUnitItems"
                        filter="true">
            </p-dropdown>
            <span style="padding-left:1em;padding-right:1em">|</span>
            <button
              (click)="showAddUnitModal()"
              class="btn btn-default btn-sm">
              <span class="glyphicon glyphicon-plus"></span>
              {{ 'addUnit' | translate }}
            </button>
          </div>
        </div>
      </div>
      <unit-edit-modal *ngIf="newUnit"
                       [unit]="newUnit"
                       (onSave)="saveUnit($event)"
                       (onCancel)="closeAddUnitModal()">
      </unit-edit-modal>
    </ng-container>

    <div class="row">
      <div class="col-sm-6 col-md-4">
        <div class="form-group">
          <label for="valueRangeMin">{{ 'valueRangeMin' | translate }}</label>
          <input [(ngModel)]="instanceVariable.valueRangeMin"
                 [ngModelOptions]="{ standalone: true }"
                 id="valueRangeMin"
                 name="valueRangeMin"
                 class="form-control"
                 type="number">
        </div>
      </div>
      <div class="col-sm-6 col-md-4">
        <div class="form-group">
          <label for="valueRangeMax">{{ 'valueRangeMax' | translate }}</label>
          <input [(ngModel)]="instanceVariable.valueRangeMax"
                 [ngModelOptions]="{ standalone: true }"
                 id="valueRangeMax"
                 name="valueRangeMax"
                 class="form-control"
                 type="number">
        </div>
      </div>
    </div>

  </ng-container>

  <ng-container *ngIf="instanceVariable.valueDomainType == 'enumerated'">
    <div *ngIf="allCodeListItems.length"
         class="row">
      <div class="col-xs-12">
        <div class="form-group">
          <label for="codeList">{{ 'codeList.label' | translate }}</label>
          <br>
          <p-dropdown [(ngModel)]="instanceVariable.codeList"
                      [ngModelOptions]="{ standalone: true }"
                      [options]="allCodeListItems"
                      filter="true"
                      autoWidth="false"
                      [style]="{'width':'60%','min-width':'400px'}"
                      inputId="codeList" placeholder="{{ 'codeListPlaceholder' | translate }}">
            <ng-template let-codeListItem pTemplate="item">
              <ng-container *ngIf="codeListItem.value; else nullValueCodeListItem;">
                <div style="min-height:2em;">
                  <button *ngIf="codeListItem.value.codeItems.length"
                          (click)="$event.preventDefault(); $event.stopPropagation(); viewCodeList = codeListItem.value; viewCodeListCodeItemsModal.toggle()"
                          class="btn btn-default btn-xs pull-right">
                    <i class="fa fa-eye" aria-hidden="true"></i>
                    {{ 'viewCodeItems' | translate }}
                  </button>
                  {{ codeListItem.value.prefLabel | lang }}
                  <span *ngIf="codeListItem.value.referenceId"
                        style="opacity:.7">
                    ({{ codeListItem.value.referenceId }})
                  </span>
                  <small style="opacity:.7">
                    <ng-container *ngIf="codeListItem.value.description | lang">
                      <br>
                      {{ codeListItem.value.description | lang | truncate:70 }}
                    </ng-container>
                    <ng-container *ngIf="codeListItem.value.owner | lang">
                      <br>
                      <em>
                        {{ 'codeList.owner' | translate }}:
                        {{ codeListItem.value.owner | lang }}
                      </em>
                    </ng-container>
                  </small>
                </div>
              </ng-container>
              <ng-template #nullValueCodeListItem>
                <p>{{ codeListItem.label }}</p>
              </ng-template>
            </ng-template>
          </p-dropdown>
          <span style="padding-left: 1em; padding-right:1em;">{{ 'or' | translate | uppercase }}</span>
          <button (click)="toggleAddCodeListModal()"
                  class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-plus"></span>
            {{ 'addCodeList' | translate }}
          </button>
        </div>
      </div>
    </div>

    <viewCodeListCodeItemsModal
      #viewCodeListCodeItemsModal
      [codeList]="viewCodeList">
    </viewCodeListCodeItemsModal>

    <p-dialog [(visible)]="showAddCodeListModal"
              modal="true"
              draggable="false"
              resizable="false"
              closeOnEscape="false"
              width="600"
              positionTop="10"
              [style]="{'max-height':'95%', 'overflow-y':'scroll'}">
      <p-header>
        {{ 'newCodeList' | translate }}
      </p-header>
      <div>
        <div class="form-group"
             style="padding-left:2px;">
          <div class="radio">
            <label>
              <input [(ngModel)]="newCodeList.codeListType" type="radio" name="codeListType" value="external">
              {{ 'codeListType.external' | translate }}
            </label>
          </div>
          <div class="radio">
            <label>
              <input [(ngModel)]="newCodeList.codeListType" type="radio" name="codeListType" value="internal">
              {{ 'codeListType.internal' | translate }}
            </label>
          </div>
        </div>
        <ng-container *ngIf="newCodeList.codeListType">
          <div *ngIf="newCodeList.codeListType == 'external'" class="form-group">
            <label for="codeList-referenceId">{{ 'codeList.referenceId' | translate }}</label>
            <input [(ngModel)]="newCodeList.referenceId"
                   id="codeList-referenceId"
                   name="codeList-referenceId"
                   type="text"
                   class="form-control">
          </div>
          <div class="form-group">
            <label for="codeList-prefLabel">
              {{ 'codeList.prefLabel' | translate }}
              <thl-requiredFieldIndicator></thl-requiredFieldIndicator>
            </label>
            <input [(ngModel)]="newCodeList.prefLabel[language]"
                   id="codeList-prefLabel"
                   name="codeList-prefLabel"
                   type="text"
                   class="form-control">
          </div>
          <div class="form-group">
            <label for="codeList-description">{{ 'codeList.description' | translate }}</label>
            <textarea [(ngModel)]="newCodeList.description[language]"
                      thlAutogrow
                      rows="2"
                      id="codeList-description"
                      name="codeList-description"
                      class="form-control">
            </textarea>
          </div>
          <div class="form-group">
            <label for="codeList-owner">{{ 'codeList.owner' | translate }}</label>
            <input [(ngModel)]="newCodeList.owner[language]"
                   id="codeList-owner"
                   name="codeList-owner"
                   type="text"
                   class="form-control">
          </div>
          <div *ngIf="newCodeList.codeListType == 'internal'">
            <label>{{ 'codeItems' | translate }}</label>
            <table *ngIf="newCodeList.codeItems.length; else noCodeItems;"
                   class="table table-striped">
              <tr>
                <th>{{ 'codeItem.code' | translate }}</th>
                <th>{{ 'codeItem.prefLabel' | translate }}</th>
                <th>{{ 'functions' | translate }}</th>
              </tr>
              <tr *ngFor="let codeItem of newCodeList.codeItems">
                <td>
                  <input [(ngModel)]="codeItem.code"
                         type="text"
                         class="form-control">
                </td>
                <td>
                  <textarea [(ngModel)]="codeItem.prefLabel[language]"
                            thlAutogrow
                            rows="1"
                            class="form-control">
                    </textarea>
                </td>
                <td>
                  <button (click)="removeCodeItem(codeItem)"
                          class="btn btn-default">
                    <i class="fa fa-trash-o" aria-hidden="true"></i>
                    {{ 'remove' | translate }}
                  </button>
                </td>
              </tr>
            </table>
            <ng-template #noCodeItems>
              <p>{{ 'noCodeItems' | translate }}</p>
            </ng-template>
            <button (click)="addCodeItem()"
                    class="btn btn-default btn-xs">
              <span class="glyphicon glyphicon-plus"></span>
              {{ 'addCodeItem' | translate }}
            </button>
          </div>
        </ng-container>
      </div>
      <p-footer>
        <div>
          <button (click)="saveCodeList()"
                  [disabled]="!newCodeList.codeListType"
                  class="btn btn-primary">
            <span class="glyphicon glyphicon-floppy-disk"></span>
            {{ 'save' | translate }}
          </button>
          <button (click)="toggleAddCodeListModal()" class="btn btn-default">
            {{ 'cancel' | translate }}
          </button>
        </div>
      </p-footer>
    </p-dialog>
  </ng-container>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="missingValues">{{ 'missingValues' | translate }}</label>
        <textarea [(ngModel)]="instanceVariable.missingValues[language]"
                  thlAutogrow
                  id="missingValues"
                  name="missingValues"
                  class="form-control"
                  rows="3">
        </textarea>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="defaultMissingValue">{{ 'defaultMissingValue' | translate }}</label>
        <input [(ngModel)]="instanceVariable.defaultMissingValue"
                  id="defaultMissingValue"
                  name="defaultMissingValue"
                  class="form-control"
                  type="text">
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="qualityStatement">{{ 'qualityStatement' | translate }}</label>
        <textarea [(ngModel)]="instanceVariable.qualityStatement[language]"
                  thlAutogrow
                  id="qualityStatement"
                  name="qualityStatement"
                  class="form-control"
                  rows="3">
        </textarea>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="source">{{ 'instanceVariableSource' | translate }}</label>
        <br>
        <p-autoComplete
                *ngIf="!instanceVariable.source || !instanceVariable.source.prefLabel"
                [(ngModel)]="instanceVariable.source"
                [ngModelOptions]="{ standalone: true }"
                [suggestions]="sourceSearchResults"
                (completeMethod)="searchSource($event)"
                dataKey="id"
                emptyMessage="{{ 'noMatchingSources' | translate }}"
                placeholder="{{ 'sourcePlaceholder' | translate }}"
                minLength="2"
                inputId="source">

          <ng-template let-source pTemplate="item">
            <span>
              {{ source.prefLabel | lang }}
            </span>
          </ng-template>

        </p-autoComplete>
        <div *ngIf="instanceVariable.source && instanceVariable.source.prefLabel">
          <span>{{instanceVariable.source.prefLabel|lang}}</span>
          <button (click)="instanceVariable.source = null"
                  class="btn btn-default btn-sm">
            <i class="fa fa-trash-o" aria-hidden="true"></i>
            {{ 'remove' | translate }}
          </button>
        </div>

      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-6 col-md-4">
      <div class="form-group">
        <label for="sourceDescription">{{ 'sourceDescription' | translate }}</label>
        <input [(ngModel)]="instanceVariable.sourceDescription[language]"
               id="sourceDescription"
               name="sourceDescription"
               class="form-control"
               type="text">
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <div class="form-group">
        <label for="dataType" translate="dataType"></label>
        <input [(ngModel)]="instanceVariable.dataType"
          id="dataType"
          name="dataType"
          type="text"
          class="form-control">
      </div>
    </div>
  </div>


<div class="row">
  <div class="col-xs-12">
    <hr>
  </div>
</div>

</form>

<ng-template #loadingInstanceVariable>
  <thl-spinner></thl-spinner>
</ng-template>

<div class="edit-controls-padding">
  <div class="edit-controls-fixed">
    <div class="container">
      <div class="row">
        <div class="col-xs-12">
          <button (click)="saveInstanceVariable()"
                  [disabled]="!instanceVariable || savingInProgress"
                  class="btn btn-primary">
            <span class="glyphicon glyphicon-floppy-disk"></span>
            {{ 'save' | translate }}
          </button>
          <button (click)="goBack()"
                  [disabled]="savingInProgress"
                  class="btn btn-default">
            {{ 'cancel' | translate }}
          </button>
          <button *ngIf="instanceVariable && instanceVariable.id"
                  (click)="confirmRemove()"
                  [disabled]="savingInProgress"
                  class="btn btn-danger pull-right">
            <i class="fa fa-trash-o" aria-hidden="true"></i>
            {{ 'remove' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
